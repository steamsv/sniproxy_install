user nobody;
worker_processes  auto;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events {
    use epoll;
    worker_connections  204800;
}

http {
    limit_conn_zone $binary_remote_addr zone=ipaddr:20m;
    server {
        listen 9527;
        fastcgi_intercept_errors on;
        include white-ipv4.conf;
        deny all;
        limit_conn ipaddr 5;
        proxy_connect_timeout 5s;
        location /ip {
            default_type text/plain;
            content_by_lua_block {
                ngx.say("IP Whitelist")
            }
        }
        error_page 403 /bk;
        location = /bk {
            default_type text/plain;
            content_by_lua_block {
                ngx.say("IP Blacklist")
            }
            allow all;
       }
    }
}

stream {
    limit_conn_zone $binary_remote_addr zone=ip_addr:20m;
    include white-ipv4.conf;
    deny all;
    server {
        listen 80;
        limit_conn ip_addr  20;
        proxy_connect_timeout 5s;
        proxy_download_rate 6000k;
        proxy_upload_rate 6000k;
        proxy_timeout 10s;
        proxy_pass tcp80;
    }
    upstream tcp80{
        server 127.0.0.1:8080;
    }
    server {
        listen 443;
        limit_conn ip_addr  20;
        proxy_connect_timeout 5s;
        proxy_download_rate 6000k;
        proxy_upload_rate 6000k;
        proxy_timeout 10s;
        proxy_pass tcp443;
    }
    upstream tcp443{
        server 127.0.0.1:8443;
    }
    server {
        listen 53;
        limit_conn ip_addr  50;
        proxy_connect_timeout 5s;
        proxy_timeout 10s;
        proxy_pass tcp53;
    }
    upstream tcp53{
        server 127.0.0.1:5353;
    }
    server {
        listen 53 udp;
        limit_conn ip_addr  50;
        proxy_connect_timeout 5s;
        proxy_timeout 10s;
        proxy_pass udp53;
    }
    upstream udp53{
        server 127.0.0.1:5353;
    }
}